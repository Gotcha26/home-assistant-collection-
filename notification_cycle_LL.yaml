blueprint:
  name: "Cycle Lave-linge â€” Notifications + PrÃ©visions SÃ©chage"
  description: >
    __Principales fonctions__ :
     * DÃ©tÃ¨cte le dÃ©but d'un cycle de mise en marche du lave-linge ainsi que sa fin de cycle.
     * Envoi automatiquement les notifications de dÃ©but/fin du lave-linge
     * Anti-rebond permet d'Ã©viter les mauvaises dÃ©tections en plein cycle.
     * La notification simple, persistante affiche un score de sÃ©chage.
     * Score qui tient compte des indicateurs mÃ©tÃ©orologique.
     * Aide Ã  la dÃ©cision pour sortir (ou non) son linge en extÃ©rieur.
     * Seuils paramÃ©trables !
     
    Dans les options ci-dessous, il sera nÃ©cessaire de crÃ©er (ou de sÃ©lÃ©ctionner) un _helper_ (entitÃ©e). L'aide est fournie.
  domain: automation
  input:

    configuration_1.1:
      name: "1.1 â€” DÃ©tÃ©ction du cycle"
      description: "ParamÃ¨tres de dÃ©tÃ©ction du cycle en cours afin de dÃ©terminer si un cycle est dÃ©marrÃ© ou terminÃ©."
      icon: mdi:toolbox-outline
      collapsed: false
      input:

        # --- Capteur Ã©nergie lave-linge ---
        power_sensor:
          name: Capteur de puissance du lave-linge
          description: "C'est le capteur d'Ã©nergie de la prise connectÃ© Ã  la machine Ã  laver le linge."
          default: "sensor.0x94a081fffe5e84fd_power"
          selector:
            entity:
              domain: sensor
              device_class: power
    
        start_threshold:
          name: Seuil puissance dÃ©marrage
          description: "Seuil de dÃ©tÃ©ction qui indique qu'un nouveau cycle est lancÃ©."
          default: 10
          selector:
            number:
              min: 1
              max: 100
              unit_of_measurement: W
    
        start_duration:
          name: DurÃ©e anti-rebond dÃ©marrage
          description: >
            DurÃ©e durant laquelle la puissance doit rester au-dessus du seuil.
            
            Si votre puissance minimun ne tombe pas en dessous ou pas durant assez longtemps, c'est parfait !
          default:
            seconds: 20
          selector:
            duration: {}
    
        stop_threshold:
          name: Seuil puissance fin de cycle
          description: "Seuil en dessous duquel la fin du cycle est dÃ©tectÃ©e."
          default: 5
          selector:
            number:
              min: 0
              max: 10
              unit_of_measurement: W
    
        stop_duration:
          name: DurÃ©e anti-rebond fin de cycle
          description: "DurÃ©e durant laquelle la puissance doit rester en dessous du seuil"
          default:
            minutes: 1
          selector:
            duration: {}
    
        cycle_flag:
          name: SÃ©lecteur du boolÃ©en
          description: >
            Permet de crÃ©er (ou de choisir !) le _helper boolÃ©en_ (entitÃ©e) pour le suivi du cycle.
            
            Ce sÃ©lÃ©cteur est juste un moyen afin de retenir l'Ã©tat du cycle en cours.
            
            _IdÃ©e : AssociÃ©ez-le Ã  la mÃªme piÃ¨ce que votre lave-linge !_
            
            IcÃ´ne conseillÃ©e : **mdi:washing-machine**
          default: "input_boolean.cycle_ll_en_cours"
          selector:
            entity:
              domain: input_boolean

        min_runtime_minutes:
          name: DurÃ©e minimale de cycle avant autoriser "fin" (minutes)
          description: "EmpÃªche la notification de fin si le cycle n'a pas durÃ© au moins X minutes (protection anti-faux arrÃªt)."
          selector:
            number:
              min: 0
              max: 240
              step: 1
              unit_of_measurement: "min"
          default: 90

    configuration_1.2:
      name: "1.2 â€” MÃ©tÃ©orologie"
      description: "Configuration des capteurs extÃ©rieurs. Ils peuvent Ãªtre physiquement chez vous ou virtuels en utilisant un service externe tel que l'intÃ©gration de MÃ©tÃ©o-France."
      icon: mdi:weather-partly-snowy-rainy
      collapsed: true
      input:

        # --- Capteurs mÃ©tÃ©o ---
        temp_sensor:
          name: TempÃ©rature extÃ©rieure
          description: "Capteur de tempÃ©rature extÃ©rieur (physique) ou issue d'un service mÃ©tÃ©orologique."
          default: "sensor.pierrelatte_temperature"
          selector:
            entity:
              domain: sensor
              device_class: temperature
    
        humidity_sensor:
          name: HumiditÃ© extÃ©rieure
          description: "Capteur d'hygromÃ©trie extÃ©rieur (physique) ou issue d'un service mÃ©tÃ©orologique."
          default: "sensor.pierrelatte_humidity"
          selector:
            entity:
              domain: sensor
              device_class: humidity
    
        wind_sensor:
          name: Vitesse du vent
          description: "Capteur de vitesse du vent (physique) ou issue d'un service mÃ©tÃ©orologique."
          default: "sensor.pierrelatte_wind_speed"
          selector:
            entity:
              domain: sensor
    
        cloud_sensor:
          name: Couverture nuageuse
          description: "Capteur de couverture nuageuse (physique) ou issue d'un service de mÃ©tÃ©oologie."
          default: "sensor.pierrelatte_cloud_cover"
          selector:
            entity:
              domain: sensor
    
        uv_sensor:
          name: Indice UV
          description: "Capteur de rayonnement UV (physique) ou issue d'un service de mÃ©tÃ©oologie."
          default: "sensor.pierrelatte_uv"
          selector:
            entity:
              domain: sensor
    
    configuration_1.3:
      name: "1.3 â€” Notifications"
      description: "Notification qui est envoyÃ©e sur votre tÃ©lÃ©phone portable via l'application Companion"
      icon: mdi:checkbox-blank-badge
      collapsed: true
      input:
    
        # --- Notification ---
        notify_service:
          name: Service de notification
          description: "Service utilisÃ© pour la notification, exemple : notify.mobile_app_xxx"
          default: "notify.mobile_app_sm_s928b"
          selector:
            text:
    
        notif_channel:
          name: Canal Android (optionnel)
          description: "Canal de notification prÃ©fÃ©rÃ©. Il faut crÃ©er en amont le canal s'il est nouveau !"
          default: "silent_channel"
          selector:
            text:
    
        # --- Messages personnalisables ---
        title_start_message:
          name: Titre du message de dÃ©but de cycle
          description: "Titre (en gras) qui apparaÃ®t en tÃªte de la notification lors du dÃ©marrage d'un cycle."
          default: "La lessive vient de dÃ©marrer ğŸš€"
          selector:
            text:
    
        title_end_message:
          name: Titre du message de fin de cycle
          description: "Titre (en gras) qui apparaÃ®t en tÃªte de la notification lors de la fin d'un cycle."
          default: "Cycle terminÃ© ğŸ§º"
          selector:
            text:
    
        custom_yaml:
          name: Bloc YAML additionnel (optionnel)
          description: "Code insÃ©rÃ© Ã  la fin de la notification (Utilisateurs expÃ©rimentÃ©s)"
          default: ""
          selector:
            text:
              multiline: true

    configuration_2.0:
      name: "2.0 â€” ParamÃ¨tres avancÃ©s â€” Calculs mÃ©tÃ©o"
      description: >
        ParamÃ¨tres de seuils afin d'affiner le score de sÃ©chage au plus prÃ¨s de la rÃ©alitÃ© de votre environement, sur le terrain.
        Un score est calculÃ© en fonction des indicateurs mis Ã  dispostion.
        Une formule mathÃ©matique calcule l'efficassitÃ© en fonction des seuils (ci-dessous) que vous dÃ©terminez.
      icon: mdi:weather-sunny
      collapsed: true
      input:
    
        min_temp_good:
          name: TempÃ©rature minimale favorable
          description: "Seuil en dessous duquel un malus sera appliquÃ© du fait d'une tempÃ©rature jugÃ©e trop faible."
          default: 15
          selector:
            number:
              min: 10
              max: 35
              step: 1
              unit_of_measurement: "Â°C"
    
        max_humidity_ok:
          name: HumiditÃ© max pour gagner 1 point
          description: "Seuil maximal oÃ¹ le taux d'humiditÃ© ambiant permet de faire sÃ©cher plus vite le linge. Au dessus de ce seuil, le sÃ©chage sera plus lent."
          default: 65
          selector:
            number:
              min: 0
              max: 100
              step: 1
              unit_of_measurement: "%"
    
        min_wind:
          name: Vent minimum pour bonus (km/h)
          description: "Plus il y a de vent, plus le processus de sÃ©chage est rapide. Seuil minimal pour gagner des points dans le calcul du score."
          default: 5
          selector:
            number:
              min: 0
              max: 30
              step: 1
    
        max_cloud:
          name: Couverture nuageuse max (%)
          description: >
            Plus il y a de nuages, moins il y a de soleil et donc plus long sera le temps de sÃ©chage car l'efficassitÃ© sera attÃ©nuÃ©e par l'accumulation des nuages.
            Seuil au dessus duquel un malus sera apposÃ© car trop de nuages.
          default: 60
          selector:
            number:
              min: 0
              max: 100
              step: 1
    
        min_uv:
          name: UV minimum pour bonus
          description: "Indiquateur qui dÃ©fini l'action des rayons du soleil. Plus il y en a et mieux c'est."
          default: 3
          selector:
            number:
              min: 0
              max: 12
              step: 1


mode: single

# ======================================================
# ===                 AUTOMATION                     ===
# ======================================================
variables:
  cycle_flag: !input cycle_flag
  input_min_runtime_minutes: !input min_runtime_minutes
  temp_sensor: !input temp_sensor
  humidity_sensor: !input humidity_sensor
  wind_sensor: !input wind_sensor
  cloud_sensor: !input cloud_sensor
  uv_sensor: !input uv_sensor

  input_min_temp_good: !input min_temp_good
  input_max_humidity_ok: !input max_humidity_ok
  input_min_wind: !input min_wind
  input_max_cloud: !input max_cloud
  input_min_uv: !input min_uv
  input_custom_yaml: !input custom_yaml


# ======================================================
# ===                 TRIGGERS                       ===
# ======================================================

trigger:
  - id: start
    platform: numeric_state
    entity_id: !input power_sensor
    above: !input start_threshold
    for: !input start_duration

  - id: end
    platform: numeric_state
    entity_id: !input power_sensor
    below: !input stop_threshold
    for: !input stop_duration

# ======================================================
# ===                 ACTIONS                        ===
# ======================================================

action:
  - choose:
      # ==== DÃ©but de cycle ====
      - conditions:
          - condition: trigger
            id: start
          - condition: state
            entity_id: !input cycle_flag
            state: "off"
        sequence:
          - service: !input notify_service
            data:
              title: !input title_start_message
              message: "La lessive est lancÃ©e, bravo. BientÃ´t ton linge va sentir bon :-)"
              data:
                sticky: true
                clickAction: "NONE"
                priority: -1
                channel: !input notif_channel
          - service: input_boolean.turn_on
            target:
              entity_id: !input cycle_flag

      # ==== Fin de cycle ====
      - conditions:
          - condition: trigger
            id: end
          - condition: state
            entity_id: !input cycle_flag
            state: "on"
          - condition: template
            value_template: >
              {% if cycle_flag and states(cycle_flag) not in [None, 'unknown', 'unavailable'] %}
                {% set cycle_entity = cycle_flag %}
                {% set start_ts = as_timestamp(states[cycle_flag].last_changed) %}
                {% set min_runtime_s = (input_min_runtime_minutes | int) * 60 %}
                {{ (as_timestamp(now()) - start_ts) > min_runtime_s }}
              {% else %}
                false
              {% endif %}
        sequence:
          - service: !input notify_service
            data:
              title: !input title_end_message
              message: >
                {% set temp = states[temp_sensor] | float(0) %}
                {% set hum = states[humidity_sensor] | float(0) %}
                {% set wind = states[wind_sensor] | float(0) %}
                {% set cloud = states[cloud_sensor] | float(0) %}
                {% set uv = states[uv_sensor] | float(0) %}
                {% set min_temp_good = input_min_temp_good | float(0) %}
                {% set max_humidity_ok = input_max_humidity_ok | float(0) %}
                {% set min_wind = input_min_wind | float(0) %}
                {% set max_cloud = input_max_cloud | float(0) %}
                {% set min_uv = input_min_uv | float(0) %}
                {% set score = 0 %}
                {% if temp > min_temp_good %}{% set score = score + 1 %}{% endif %}
                {% if hum < max_humidity_ok %}{% set score = score + 1 %}{% endif %}
                {% if wind > min_wind %}{% set score = score + 1 %}{% endif %}
                {% if cloud < max_cloud %}{% set score = score + 1 %}{% endif %}
                {% set sunset_ts = state_attr('sun.sun', 'next_setting') | as_timestamp %}
                {% set now_ts = now() | as_timestamp %}
                {% if (now_ts < sunset_ts) and (uv > min_uv) %}
                  {% set score = score + 1 %}
                {% endif %}
                {{ temp }}Â°C â€” {{ hum }}% â€” Vent {{ wind }} km/h
                â˜€ï¸ Indice sÃ©chage : {{ score }}/5
                ğŸ•’ Temps estimÃ© :
                {% set base = 4 %}
                {% if temp < min_temp_good %}{% set base = base + 2 %}{% elif temp > (min_temp_good + 5) %}{% set base = base - 1 %}{% endif %}
                {% if hum > (max_humidity_ok + 15) %}{% set base = base + 3 %}{% elif hum < (max_humidity_ok - 15) %}{% set base = base - 1 %}{% endif %}
                {% if wind > (min_wind + 5) %}{% set base = base - 1 %}{% elif wind < min_wind %}{% set base = base + 1 %}{% endif %}
                {% if score == 0 %}{% set base = base + 4 %}{% elif score == 1 %}{% set base = base + 2 %}{% elif score >= 4 %}{% set base = base - 1 %}{% endif %}
                {% set temps_est = [base, 1] | max %}
                {% set finish_ts = now_ts + (temps_est * 3600) %}
                {% if finish_ts > sunset_ts %}
                  {% set temps_est = ((sunset_ts - now_ts) / 3600) | round(1) %}
                {% endif %}
                {{ temps_est }} h
                {% if finish_ts > sunset_ts %}
                âš ï¸ Fin prÃ©vue APRÃˆS le coucher du soleil â€” Ã©tendage extÃ©rieur **non recommandÃ©**.
                {% elif score >= 2 %}
                Conditions favorables ğŸ‘
                â€” Ã©tendage extÃ©rieur conseillÃ©.
                {% else %}
                SÃ©chage difficile ğŸ˜•
                â€” mieux vaut Ã©tendre Ã  l'intÃ©rieur.
                {% endif %}
                {{ '\n' + (input_custom_yaml if input_custom_yaml != '' else '') }}
              data:
                sticky: true
                clickAction: "NONE"
                priority: -1
                channel: !input notif_channel
          - service: input_boolean.turn_off
            target:
              entity_id: !input cycle_flag
