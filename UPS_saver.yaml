blueprint:
  name: Gestion compl√®te UPS Eaton / Homelab (Blueprint)
  description: >
    Notifications UPS + arr√™t automatique du homelab + boutons mobiles.
    Version Blueprint enti√®rement configurable.
  domain: automation
  input:

    configuration_ups:
      name: "1 - Configuration de l'UPS"
      description: "Param√®tres de votre UPS."
      icon: mdi:toolbox-outline
      collapsed: false
      input:

        ups_base:
          name: "Entit√© de base UPS"
          description: "Exemple : sensor.eaton3s"
          selector:
            entity:
              filter:
                - domain: sensor

        ups_runtime:
          name: Autonomie UPS (en secondes)
          description: Entit√© contenant l‚Äôautonomie restante en secondes.
          selector:
            entity:
              filter:
                - domain: sensor

        ups_human_state:
          name: √âtat UPS (texte)
          description: Entit√© texte d√©crivant l‚Äô√©tat de l‚ÄôUPS.
          selector:
            entity:
              filter:
                - domain: sensor

        critical_pattern:
          name: Codes d‚Äô√©tat batterie critique
          description: >
            Texte de l'entit√© lors du passage en alarme.<br/>
            Par d√©faut : "ALARM OB OL"
          default: "ALARM OB OL"
          selector:
            text:

        critical_delay:
          name: Dur√©e avant arr√™t critique (secondes)
          default: 30
          selector:
            number:
              min: 5
              max: 600
              unit_of_measurement: sec
              mode: slider

    configuration_notifications:
      name: "2 - Configuration notifications App Comagnon"
      description: "Service de notification via l'application mobile Compagnon."
      icon: mdi:checkbox-blank-badge
      collapsed: true
      input:

        mobile_notify:
          name: Service de notification mobile
          description: Service `notify.xxx` pour envoyer les messages.
          selector:
            action:

        shutdown_service:
          name: Service d‚Äôarr√™t du homelab
          description: Service (shell_command, script, etc.) qui d√©clenche l‚Äôarr√™t Proxmox.
          selector:
            action:

mode: single

trigger:
  - id: coupure_30s
    platform: state
    entity_id: "{{ blueprint.inputs.ups_base }}_code_d_etat"
    to: "OB"
    for: "00:00:05"

  - id: autonomie_critique
    platform: state
    entity_id: "{{ blueprint.inputs.ups_base }}_code_d_etat"
    to: !input critical_pattern
    for:
      seconds: !input critical_delay

  - id: courant_retour
    platform: state
    entity_id: "{{ blueprint.inputs.ups_base }}_code_d_etat"
    to: "OL"

  - id: check_remaining
    platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: CHECK_REMAINING

action:
  - choose:

      - conditions:
          - condition: trigger
            id: coupure_30s
        sequence:
          - alias: "Notification coupure √©lectrique"
            service: !input mobile_notify
            data:
              title: ‚ö†Ô∏è Coupure √©lectrique d√©tect√©e
              message: >-
                {% set s = states(blueprint.inputs.ups_runtime) | int(0) %}
                {% if s > 0 %}
                  {% set h = s // 3600 %}
                  {% set m = (s % 3600) // 60 %}
                  {% set sec = s % 60 %}
                  {% set end = (now() + timedelta(seconds=s)).strftime("%H:%M:%S") %}
                  L'UPS est sur batterie depuis plus de 30 secondes.  
                  **Autonomie restante : {{ "%02d:%02d:%02d" | format(h, m, sec) }}**  
                  **Extinction estim√©e √† : {{ end }}**
                {% else %}
                  L'UPS est sur batterie depuis plus de 30 secondes.  
                  Autonomie inconnue.
                {% endif %}
              data:
                sticky: true
                channel: UPS Alerts
                importance: high
                priority: high
                actions:
                  - action: CHECK_REMAINING
                    title: V√©rifier l'autonomie
                  - action: FORCE_SHUTDOWN
                    title: Forcer l'arr√™t du homelab

      - conditions:
          - condition: trigger
            id: autonomie_critique
        sequence:
          - alias: "Alerte critique + arr√™t"
            service: !input mobile_notify
            data:
              title: ‚õî Arr√™t automatique homelab
              message: >-
                Niveau batterie critique d√©tect√© (`{{ states(blueprint.inputs.ups_base ~ "_code_d_etat") }}`).  
                Extinction imm√©diate et propre du homelab.
              data:
                sticky: true
                channel: UPS Alerts
                importance: high
                priority: high
          - delay:
              seconds: !input critical_delay
          - alias: "Lancement arr√™t"
            service: !input shutdown_service

      - conditions:
          - condition: trigger
            id: courant_retour
        sequence:
          - alias: "Courant r√©tabli"
            service: !input mobile_notify
            data:
              title: üîå Courant r√©tabli
              message: >
                L'alimentation secteur est revenue.  
                L'UPS fonctionne normalement.
              data:
                sticky: true
                channel: UPS Alerts
                importance: high
                priority: high

      - conditions:
          - condition: trigger
            id: check_remaining
        sequence:
          - alias: "Check autonomie manuelle"
            service: !input mobile_notify
            data:
              title: üîç Autonomie actuelle
              message: >-
                {% set s = states(blueprint.inputs.ups_runtime) | int(0) %}
                {% if s > 0 %}
                  {% set h = s // 3600 %}
                  {% set m = (s % 3600) // 60 %}
                  {% set sec = s % 60 %}
                  {% set end = (now() + timedelta(seconds=s)).strftime("%H:%M:%S") %}
                  Check-in.  
                  **Autonomie : {{ "%02d:%02d:%02d" | format(h, m, sec) }}**  
                  **Extinction estim√©e : {{ end }}**
                {% else %}
                  **Autonomie : inconnue**
                {% endif %}  
                **√âtat UPS :** {{ states(blueprint.inputs.ups_human_state) }}
              data:
                sticky: true
                channel: UPS Alerts
                importance: high
                priority: high
                actions:
                  - action: FORCE_SHUTDOWN
                    title: Forcer l'arr√™t du homelab
