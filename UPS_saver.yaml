blueprint:
  name: Gestion complÃ¨te UPS Eaton / Homelab (Blueprint)
  description: >
    Notifications UPS + arrÃªt automatique du homelab + boutons mobiles.
    Version Blueprint entiÃ¨rement configurable.
  domain: automation
  input:
    ups_state:
      name: Ã‰tat UPS (code dâ€™Ã©tat)
      description: EntitÃ© permettant de dÃ©tecter OB / OL / ALARM.
      selector:
        entity:
          filter:
            - domain: sensor

    ups_runtime:
      name: Autonomie UPS (en secondes)
      description: EntitÃ© contenant lâ€™autonomie restante en secondes.
      selector:
        entity:
          filter:
            - domain: sensor

    ups_human_state:
      name: Ã‰tat UPS (texte)
      description: EntitÃ© texte dÃ©crivant lâ€™Ã©tat de lâ€™UPS.
      selector:
        entity:
          filter:
            - domain: sensor

    mobile_notify:
      name: Service de notification mobile
      description: Service `notify.xxx` pour envoyer les messages.
      selector:
        action:

    shutdown_service:
      name: Service dâ€™arrÃªt du homelab
      description: Service (shell_command, script, etc.) qui dÃ©clenche lâ€™arrÃªt Proxmox.
      selector:
        action:

    critical_pattern:
      name: Codes dâ€™Ã©tat batterie critique
      description: Ex : "ALARM OB OL"
      default: "ALARM OB OL"
      selector:
        text:

    critical_delay:
      name: DurÃ©e avant arrÃªt critique (secondes)
      default: 30
      selector:
        number:
          min: 5
          max: 600
          unit_of_measurement: sec
          mode: slider

mode: single

trigger:
  - id: coupure_30s
    platform: state
    entity_id: !input ups_state
    to: "OB"
    for: "00:00:05"

  - id: autonomie_critique
    platform: state
    entity_id: !input ups_state
    to: !input critical_pattern
    for:
      seconds: !input critical_delay

  - id: courant_retour
    platform: state
    entity_id: !input ups_state
    to: "OL"

  - id: check_remaining
    platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: CHECK_REMAINING

action:
  - choose:

      - conditions:
          - condition: trigger
            id: coupure_30s
        sequence:
          - alias: "Notification coupure Ã©lectrique"
            service: !input mobile_notify
            data:
              title: âš ï¸ Coupure Ã©lectrique dÃ©tectÃ©e
              message: >-
                {% set s = states(blueprint.inputs.ups_runtime) | int(0) %}
                {% if s > 0 %}
                  {% set h = s // 3600 %}
                  {% set m = (s % 3600) // 60 %}
                  {% set sec = s % 60 %}
                  {% set end = (now() + timedelta(seconds=s)).strftime("%H:%M:%S") %}
                  L'UPS est sur batterie depuis plus de 30 secondes.  
                  **Autonomie restante : {{ "%02d:%02d:%02d" | format(h, m, sec) }}**  
                  **Extinction estimÃ©e Ã  : {{ end }}**
                {% else %}
                  L'UPS est sur batterie depuis plus de 30 secondes.  
                  Autonomie inconnue.
                {% endif %}
              data:
                sticky: true
                channel: UPS Alerts
                importance: high
                priority: high
                actions:
                  - action: CHECK_REMAINING
                    title: VÃ©rifier l'autonomie
                  - action: FORCE_SHUTDOWN
                    title: Forcer l'arrÃªt du homelab

      - conditions:
          - condition: trigger
            id: autonomie_critique
        sequence:
          - alias: "Alerte critique + arrÃªt"
            service: !input mobile_notify
            data:
              title: â›” ArrÃªt automatique homelab
              message: >-
                Niveau batterie critique dÃ©tectÃ© (`{{ states(blueprint.inputs.ups_state) }}`).  
                Extinction immÃ©diate et propre du homelab.
              data:
                sticky: true
                channel: UPS Alerts
                importance: high
                priority: high
          - delay:
              seconds: !input critical_delay
          - alias: "Lancement arrÃªt"
            service: !input shutdown_service

      - conditions:
          - condition: trigger
            id: courant_retour
        sequence:
          - alias: "Courant rÃ©tabli"
            service: !input mobile_notify
            data:
              title: ðŸ”Œ Courant rÃ©tabli
              message: >
                L'alimentation secteur est revenue.  
                L'UPS fonctionne normalement.
              data:
                sticky: true
                channel: UPS Alerts
                importance: high
                priority: high

      - conditions:
          - condition: trigger
            id: check_remaining
        sequence:
          - alias: "Check autonomie manuelle"
            service: !input mobile_notify
            data:
              title: ðŸ” Autonomie actuelle
              message: >-
                {% set s = states(blueprint.inputs.ups_runtime) | int(0) %}
                {% if s > 0 %}
                  {% set h = s // 3600 %}
                  {% set m = (s % 3600) // 60 %}
                  {% set sec = s % 60 %}
                  {% set end = (now() + timedelta(seconds=s)).strftime("%H:%M:%S") %}
                  Check-in.  
                  **Autonomie : {{ "%02d:%02d:%02d" | format(h, m, sec) }}**  
                  **Extinction estimÃ©e : {{ end }}**
                {% else %}
                  **Autonomie : inconnue**
                {% endif %}  
                **Ã‰tat UPS :** {{ states(blueprint.inputs.ups_human_state) }}
              data:
                sticky: true
                channel: UPS Alerts
                importance: high
                priority: high
                actions:
                  - action: FORCE_SHUTDOWN
                    title: Forcer l'arrÃªt du homelab
