blueprint:
  name: Gestion compl√®te UPS Eaton / Homelab (Blueprint)
  description: >
    Notifications UPS + arr√™t automatique du homelab + boutons mobiles.
    Version Blueprint enti√®rement configurable, avec d√©tection automatique
    des entit√©s UPS via une entit√© de r√©f√©rence.
  domain: automation

  input:

    # --- Configuration UPS ---
    configuration_ups:
      name: "1 - Configuration de l'UPS"
      description: "Param√®tres de votre UPS."
      icon: mdi:toolbox-outline
      collapsed: false
      input:
        ups_state_code:
          name: Code d‚Äô√©tat
          description: >
            Entit√© permettant de d√©tecter OB / OL / ALARM.<br/>
            D√©faut : "Code d'√©tat"<br/>
            (ex : `sensor.eaton3s_code_d_etat`)
          default: "sensor.eaton3s_code_d_etat"
          selector:
            entity:
              domain: sensor

        ups_runtime:
          name: Autonomie de la batterie
          description: >
            Entit√© d√©finissant l‚Äôautonomie restante (en secondes).<br/>
            D√©faut : "Autonomie de la batterie"<br/>
            (ex: `sensor.eaton3s_autonomie_de_la_batterie`)
          default: "sensor.eaton3s_autonomie_de_la_batterie"
          selector:
            entity:
              domain: sensor

        ups_state_text:
          name: √âtat
          description: >
            Entit√© texte d√©crivant l‚Äô√©tat de l‚ÄôUPS.<br/>
            D√©faut : "√âtat"<br/>
            (ex : `sensor.eaton3s_etat`)
          default: "sensor.eaton3s_etat"
          selector:
            entity:
              domain: sensor


    # --- Notifications ---
    configuration_notifications:
      name: "2 - Configuration notifications App Compagnon"
      description: "Service de notification via l'application mobile Compagnon."
      icon: mdi:checkbox-blank-badge
      collapsed: true
      input:
        notify_mobile:
          name: "Service de notification mobile"
          description: >
            Service utilis√© pour la notification.<br/>
            (ex :  `notify.mobile_app_sm_s928b`)
          default: "notify.mobile_app_sm_s928b"
          selector:
            text:

        notif_channel:
          name: Canal Android (optionnel)
          description: "Canal de notification pr√©f√©r√©. Il faut cr√©er en amont le canal s'il est nouveau !"
          default: "UPS_channel"
          selector:
            text:

    # --- Configuration √©labor√©e ---
    configuration_shell:
      name: "3 - Configuration sp√©cifique"
      description: "Configuration des actions sp√©cifiques."
      icon: mdi:wrench-clock
      collapsed: true
      input:
        shutdown_service:
          name: "Service d‚Äôarr√™t du homelab"
          description: >
            Service (shell_command, script, etc.) d√©clenchant l‚Äôarr√™t Proxmox.<br/>
            (ex : `shell_command.create_shutdown_file`)
          default: "shell_command.create_shutdown_file"
          selector:
            text:

        critical_pattern:
          name: Codes d‚Äô√©tat batterie critique
          description: >
            Texte exact de l'entit√© lors du passage en alarme.<br/>
            Par d√©faut : "ALARM OB OL"<br/>
            **Ne modifiez pas ce champ sauf exception !**
          default: "ALARM OB OL"
          selector:
            text:

        critical_delay:
          name: Dur√©e avant arr√™t critique (secondes)
          description: "Apr√®s le d√©clenchement de l'alarme au niveau bas (20%), d√©lai suppl√©mentaire avant le d√©clenchement de la phase critique."
          default: 30
          selector:
            number:
              min: 5
              max: 600
              unit_of_measurement: sec
              mode: slider

mode: single


# ======================================================
# ===                 AUTOMATION                     ===
# ======================================================

variables:

  # --- Configuration UPS ---
  v_ups_runtime: !input ups_runtime
  v_ups_state_code: !input ups_state_code
  v_ups_state_text: !input ups_state_text

  # --- Configuration sp√©cifique ---
  v_critical_delay: !input critical_delay

  # fallback
  critical_pattern: >
    {% if inputs.critical_pattern | trim == "" %}
      ALARM OB OL
    {% else %}
      {{ inputs.critical_pattern }}
    {% endif %}


# ======================================================
# ===                 TRIGGERS                       ===
# ======================================================

trigger:
  - id: OB_begin
    platform: state
    entity_id: !input ups_state_code
    to: "OB"
    for: "00:00:05"

  - id: autonomie_critique
    platform: state
    entity_id: !input ups_state_code
    to: !input critical_pattern
    for: "{{ v_critical_delay | int }} seconds"

  - id: courant_retour
    platform: state
    entity_id: !input ups_state_code
    to: "OL"

  - id: check_remaining
    platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: CHECK_REMAINING


# ======================================================
# ===                 ACTIONS                        ===
# ======================================================

action:
  - choose:

      # --- Coupure secteur ---
      - conditions:
          - condition: trigger
            id: OB_begin
        sequence:
          - service: !input notify_mobile
            data:
              title: "‚ö†Ô∏è Coupure √©lectrique d√©tect√©e"
              message: >-
                {% set s = states(v_ups_runtime) | int(0) %}
                {% if s > 0 %}
                  {% set h = s // 3600 %}
                  {% set m = (s % 3600) // 60 %}
                  {% set sec = s % 60 %}
                  {% set end = (now() + timedelta(seconds=s)).strftime("%H:%M:%S") %}
                  L'UPS est sur batterie depuis plus de 30 secondes.  
                  **Autonomie restante : {{ "%02d:%02d:%02d" | format(h, m, sec) }}**  
                  **Extinction estim√©e √† : {{ end }}**
                {% else %}
                  L'UPS est sur batterie depuis plus de 30 secondes.  
                  Autonomie inconnue.
                {% endif %}
              sticky: true
              channel: UPS Alerts
              importance: high
              priority: high
              actions:
                - action: CHECK_REMAINING
                  title: V√©rifier autonomie
                - action: FORCE_SHUTDOWN
                  title: Forcer arr√™t du homelab

      # --- Autonomie critique ---
      - conditions:
          - condition: trigger
            id: autonomie_critique
        sequence:
          - service: !input notify_mobile
            data:
              title: "‚õî Arr√™t automatique homelab"
              message: >-
                Batterie critique d√©tect√©e (`{{ states(v_ups_state_code) }}`).  
                Extinction imm√©diate et propre du homelab.
              sticky: true
              channel: UPS Alerts
              importance: high
              priority: high

          - delay:
              seconds: "{{ v_critical_delay }}"

          - service: !input shutdown_service

      # --- Courant r√©tabli ---
      - conditions:
          - condition: trigger
            id: courant_retour
        sequence:
          - service: !input notify_mobile
            data:
              title: "üîå Courant r√©tabli"
              message: >
                L'alimentation secteur est revenue.  
                L'UPS fonctionne normalement.
              sticky: true
              channel: UPS Alerts
              importance: high
              priority: high

      # --- Bouton "Check autonomie" ---
      - conditions:
          - condition: trigger
            id: check_remaining
        sequence:
          - service: !input notify_mobile
            data:
              title: "üîç Autonomie actuelle"
              message: >-
                {% set s = states(v_ups_runtime) | int(0) %}
                {% if s > 0 %}
                  {% set h = s // 3600 %}
                  {% set m = (s % 3600) // 60 %}
                  {% set sec = s % 60 %}
                  {% set end = (now() + timedelta(seconds=s)).strftime("%H:%M:%S") %}
                  Check-in.  
                  **Autonomie : {{ "%02d:%02d:%02d" | format(h, m, sec) }}**  
                  **Extinction estim√©e : {{ end }}**
                {% else %}
                  **Autonomie : inconnue**
                {% endif %}
                **√âtat UPS :** {{ states(v_ups_state_text) }}
              sticky: true
              channel: UPS Alerts
              importance: high
              priority: high
              actions:
                - action: FORCE_SHUTDOWN
                  title: Forcer arr√™t du homelab
