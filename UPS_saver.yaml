blueprint:
  name: Gestion complÃ¨te UPS Eaton / Homelab (Blueprint)
  description: >
    Notifications UPS + arrÃªt automatique du homelab + boutons mobiles.
    Version Blueprint entiÃ¨rement configurable, avec dÃ©tection automatique
    des entitÃ©s UPS via une entitÃ© de rÃ©fÃ©rence.
  domain: automation

  input:
    configuration_ups:
      name: "1 - Configuration de l'UPS"
      description: "ParamÃ¨tres de votre UPS."
      icon: mdi:toolbox-outline
      collapsed: false
      input:
        ups_state_code:
          name: Code dâ€™Ã©tat
          default: sensor.eaton3s_code_d_etat
          selector:
            entity:
              domain: sensor
        ups_runtime:
          name: Autonomie de la batterie
          default: sensor.eaton3s_autonomie_de_la_batterie
          selector:
            entity:
              domain: sensor
        ups_state_text:
          name: Ã‰tat
          default: sensor.eaton3s_etat
          selector:
            entity:
              domain: sensor

    configuration_notifications:
      name: "2 - Configuration notifications App Compagnon"
      icon: mdi:checkbox-blank-badge
      collapsed: true
      input:
        notify_mobile:
          name: Service de notification mobile
          default: notify.mobile_app_sm_s928b
          selector:
            text:
        notif_channel:
          name: Canal Android (optionnel)
          default: UPS_channel
          selector:
            text:

    configuration_shell:
      name: "3 - Configuration spÃ©cifique"
      collapsed: true
      input:
        shutdown_service:
          name: Service dâ€™arrÃªt du homelab
          default: shell_command.create_shutdown_file
          selector:
            text:
        critical_pattern:
          name: Codes dâ€™Ã©tat batterie critique
          default: "ALARM OB OL"
          selector:
            text:
        critical_delay:
          name: DurÃ©e avant arrÃªt critique (secondes)
          default: 30
          selector:
            number:
              min: 5
              max: 600
              unit_of_measurement: sec
              mode: slider

mode: single

trigger:
  - id: OB_begin
    platform: state
    entity_id: !input ups_state_code
    to: "OB"
    for: "00:00:05"

  - id: autonomie_critique
    platform: state
    entity_id: !input ups_state_code
    to: !input critical_pattern
    for:
      seconds: !input critical_delay

  - id: courant_retour
    platform: state
    entity_id: !input ups_state_code
    to: "OL"

  - id: check_remaining
    platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: CHECK_REMAINING

action:
  - choose:
      - conditions:
          - condition: trigger
            id: OB_begin
        sequence:
          - service: !input notify_mobile
            data:
              title: "âš ï¸ Coupure Ã©lectrique dÃ©tectÃ©e"
              message: >-
                {% set s = states(!input ups_runtime) | int(0) %}
                {% if s > 0 %}
                  {% set h = s // 3600 %}
                  {% set m = (s % 3600) // 60 %}
                  {% set sec = s % 60 %}
                  {% set end = (now() + timedelta(seconds=s)).strftime("%H:%M:%S") %}
                  L'UPS est sur batterie depuis plus de 30 secondes.  
                  **Autonomie restante : {{ "%02d:%02d:%02d" | format(h, m, sec) }}**  
                  **Extinction estimÃ©e : {{ end }}**
                {% else %}
                  L'UPS est sur batterie depuis plus de 30 secondes.  
                  Autonomie inconnue.
                {% endif %}
              sticky: true
              channel: !input notif_channel
              importance: high
              priority: high
              actions:
                - action: CHECK_REMAINING
                  title: VÃ©rifier autonomie
                - action: FORCE_SHUTDOWN
                  title: Forcer arrÃªt du homelab

      - conditions:
          - condition: trigger
            id: autonomie_critique
        sequence:
          - service: !input notify_mobile
            data:
              title: "â›” ArrÃªt automatique homelab"
              message: >-
                Batterie critique dÃ©tectÃ©e (`{{ states(!input ups_state_code) }}`).  
                Extinction immÃ©diate et propre du homelab.
              sticky: true
              channel: !input notif_channel
              importance: high
              priority: high
          - delay:
              seconds: !input critical_delay
          - service: !input shutdown_service

      - conditions:
          - condition: trigger
            id: courant_retour
        sequence:
          - service: !input notify_mobile
            data:
              title: "ðŸ”Œ Courant rÃ©tabli"
              message: >
                L'alimentation secteur est revenue.  
                L'UPS fonctionne normalement.
              sticky: true
              channel: !input notif_channel
              importance: high
              priority: high

      - conditions:
          - condition: trigger
            id: check_remaining
        sequence:
          - service: !input notify_mobile
            data:
              title: "ðŸ” Autonomie actuelle"
              message: >-
                {% set s = states(!input ups_runtime) | int(0) %}
                {% if s > 0 %}
                  {% set h = s // 3600 %}
                  {% set m = (s % 3600) // 60 %}
                  {% set sec = s % 60 %}
                  {% set end = (now() + timedelta(seconds=s)).strftime("%H:%M:%S") %}
                  Check-in.  
                  **Autonomie : {{ "%02d:%02d:%02d" | format(h, m, sec) }}**  
                  **Extinction estimÃ©e : {{ end }}**
                {% else %}
                  **Autonomie : inconnue**
                {% endif %}
                **Ã‰tat UPS :** {{ states(!input ups_state_text) }}
              sticky: true
              channel: !input notif_channel
              importance: high
              priority: high
              actions:
                - action: FORCE_SHUTDOWN
                  title: Forcer arrÃªt du homelab
